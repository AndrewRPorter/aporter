# first we declare our upstream server, which is our Gunicorn application
upstream flask-app {
    # docker will automatically resolve this to the correct address
    # because we use the same name as the service: "djangoapp"
    server flask:8080;
}

server {
    listen 80;
    listen [::]:80;
    server_name aporter.me www.aporter.me;

    root /var/www/;

    location / {
        rewrite ^ https://$host$request_uri? permanent;
    }
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name aporter.me www.aporter.me;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/aporter.me/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/aporter.me/privkey.pem;
    ssl_dhparam /etc/ssl/certs/dhparam-2048.pem;

    location ~ /.well-known/acme-challenge {
        root /var/www/;
    }

    location / {
        proxy_pass http://flask-app;
    }
}